name: Uptycs Vulnerability Scanner
description: Scans containers for known vulnerabilities
author: Uptycs
inputs:
  #############################################################################
  # Required Inputs
  #############################################################################
  uptycs-secret:
    description: Tenant-specific secret for authenticating to uptycs
    required: true
  osquery-flags:
    description: Flags file to be used by osquery
    required: true
  image-id:
    description: ID of the docker image to scan for vulnerabilities
    required: true
  #############################################################################
  # Optional inputs
  #############################################################################
  fatal-cvss-score:
    description: The CVSS score at which a detected vulnerability should fail the build
    required: false
    default: '8'
runs:
  # using: 'docker'
  # image: 'docker://uptycs/uptycs-ci:5.3.0.11-Uptycs-202208291926-x86_64-2-delete-2'
  # args:
  #   - --image-id=${{ inputs.image-id }}
  #   - --osquery-flags=${{ inputs.osquery-flags }}
  #   - --uptycs-secret=${{ inputs.uptycs-secret }}
  #   - --fatal-cvss-score=${{ inputs.fatal-cvss-score }}
  #   - --ci-runner-type=github
  # env:
  #   UPTYCS_SECRET: ${{ inputs.uptycs-secret }}
  #   OSQUERY_FLAGS: ${{ inputs.osquery-flags }}
  using: 'composite'
  steps:
    - shell: bash
      run: | 
        mkdir .secret && env | grep 'GITHUB_\|ACTIONS_\|RUNNER_\|INPUT_\|CI' > .secret/github_env
    - shell: bash
      run: |
        docker run --rm --privileged \
          --pid host \
          --net host \
          --restart no \
          --env-file .secret/github_env \
          --volume /var/run/docker.sock:/var/run/docker.sock:ro \
          --volume /var/run/docker.pid:/var/run/docker.pid:ro \
          --volume "$GITHUB_STEP_SUMMARY:$GITHUB_STEP_SUMMARY" \
          --env "GITHUB_STEP_SUMMARY=$GITHUB_STEP_SUMMARY" \
          uptycs/uptycs-ci:5.3.0.11-Uptycs-202208291926-x86_64-2-delete-2 \
          --image-id=${{ inputs.image-id }} \
          --osquery-flags=${{ inputs.osquery-flags }} \
          --uptycs-secret=${{ inputs.uptycs-secret }} \
          --fatal-cvss-score=${{ inputs.fatal-cvss-score }} \
          --ci-runner-type=github
  #     env:
  #       UPTYCS_SECRET: ${{ inputs.uptycs-secret }}
  #       OSQUERY_FLAGS: ${{ inputs.osquery-flags }}
